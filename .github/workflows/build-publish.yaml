name: Build and Publish Tool Images

on:
  push:
    branches: [main]
    paths:
      - 'tools/**'
      - 'packages/mcp-common/**'
  pull_request:
    branches: [main]
    paths:
      - 'tools/**'
      - 'packages/mcp-common/**'
  workflow_dispatch:
    inputs:
      tool:
        description: 'Specific tool to build (leave empty for all changed)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: silicon-works/mcp-tools

jobs:
  # Detect which tools have changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      tools: ${{ steps.filter-tools.outputs.tools }}
      mcp-common: ${{ steps.filter.outputs.mcp-common }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            mcp-common:
              - 'packages/mcp-common/**'
            curl:
              - 'tools/curl/**'
            cve-lookup:
              - 'tools/cve-lookup/**'
            enum4linux-ng:
              - 'tools/enum4linux-ng/**'
            exploit-runner:
              - 'tools/exploit-runner/**'
            ffuf:
              - 'tools/ffuf/**'
            ftp:
              - 'tools/ftp/**'
            hash-lookup:
              - 'tools/hash-lookup/**'
            hydra:
              - 'tools/hydra/**'
            john:
              - 'tools/john/**'
            lfi-rfi:
              - 'tools/lfi-rfi/**'
            metasploit:
              - 'tools/metasploit/**'
            mongodb:
              - 'tools/mongodb/**'
            mysql:
              - 'tools/mysql/**'
            netcat:
              - 'tools/netcat/**'
            nikto:
              - 'tools/nikto/**'
            nmap:
              - 'tools/nmap/**'
            nosqlmap:
              - 'tools/nosqlmap/**'
            nuclei:
              - 'tools/nuclei/**'
            office-exploit:
              - 'tools/office-exploit/**'
            payload:
              - 'tools/payload/**'
            privesc:
              - 'tools/privesc/**'
            searchsploit:
              - 'tools/searchsploit/**'
            sqlite:
              - 'tools/sqlite/**'
            sqlmap:
              - 'tools/sqlmap/**'
            shell-session:
              - 'tools/shell-session/**'
            ssh:
              - 'tools/ssh/**'
            target-tracker:
              - 'tools/target-tracker/**'
            tunnel:
              - 'tools/tunnel/**'
            web-fingerprint:
              - 'tools/web-fingerprint/**'
            web-session:
              - 'tools/web-session/**'
            wpscan:
              - 'tools/wpscan/**'
            zap:
              - 'tools/zap/**'
            ike-scan:
              - 'tools/ike-scan/**'
            scapy:
              - 'tools/scapy/**'
            strongswan:
              - 'tools/strongswan/**'
            playwright:
              - 'tools/playwright/**'

      - name: Filter out mcp-common from tools list
        id: filter-tools
        run: |
          CHANGES='${{ steps.filter.outputs.changes }}'
          TOOLS=$(echo "$CHANGES" | jq -c '[.[] | select(. != "mcp-common")]')
          echo "tools=$TOOLS" >> $GITHUB_OUTPUT

  # Build and push tool images
  build:
    needs: changes
    runs-on: ubuntu-latest
    if: ${{ needs.changes.outputs.tools != '[]' || github.event.inputs.tool != '' }}
    strategy:
      fail-fast: false
      matrix:
        tool: ${{ github.event.inputs.tool != '' && fromJson(format('["{0}"]', github.event.inputs.tool)) || fromJson(needs.changes.outputs.tools) }}

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Check if tool exists
        id: check
        run: |
          if [ -d "tools/${{ matrix.tool }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        if: steps.check.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: steps.check.outputs.exists == 'true' && github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        if: steps.check.outputs.exists == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.tool }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix=
            type=ref,event=pr

      - name: Build and push
        if: steps.check.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: tools/${{ matrix.tool }}/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Note: GitHub API doesn't support changing visibility for org packages
      # Packages must be made public manually via GitHub UI
      # See: https://github.com/orgs/community/discussions/55094

      - name: Output image info
        if: steps.check.outputs.exists == 'true'
        run: |
          echo "### Built Image: ${{ matrix.tool }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Build all tools if mcp-common changed
  build-all:
    needs: changes
    runs-on: ubuntu-latest
    if: ${{ needs.changes.outputs.mcp-common == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        tool: [curl, cve-lookup, enum4linux-ng, exploit-runner, ffuf, ftp, hash-lookup, hydra, ike-scan, john, lfi-rfi, metasploit, mongodb, mysql, netcat, nikto, nmap, nosqlmap, nuclei, office-exploit, payload, playwright, privesc, scapy, searchsploit, shell-session, sqlite, sqlmap, ssh, strongswan, target-tracker, tunnel, web-fingerprint, web-session, wpscan, zap]

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Check if tool exists
        id: check
        run: |
          if [ -d "tools/${{ matrix.tool }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        if: steps.check.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: steps.check.outputs.exists == 'true' && github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        if: steps.check.outputs.exists == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.tool }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix=

      - name: Build and push
        if: steps.check.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: tools/${{ matrix.tool }}/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Note: GitHub API doesn't support changing visibility for org packages
      # Packages must be made public manually via GitHub UI
      # See: https://github.com/orgs/community/discussions/55094
